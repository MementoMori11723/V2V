<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="Voice to Voice" />
  <meta name="keywords" content="Voice to Voice" />
  <meta name="author" content="Voice to Voice" />
  <title>Voice to Voice Bot</title>

  <!-- here is our script & style files -->
  <script>
    let isRecording = false;
    let recognition;

    function record() {
      let txtarea = document.getElementById("voice-input");
      const recordBtn = document.getElementById("record");
      window.SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

      if (!isRecording) {
        recognition = new SpeechRecognition();
        recognition.interimResults = true;
        recognition.lang = "en-US";
        recognition.continuous = true;
        recognition.start();
        isRecording = true;
        recordBtn.innerHTML = "Stop";

        recognition.addEventListener("result", (e) => {
          const transcript = Array.from(e.results)
            .map((result) => result[0])
            .map((result) => result.transcript)
            .join("");
          txtarea.value = transcript;
        });

        recognition.addEventListener("end", () => {
          if (isRecording) {
            recognition.start();
          }
        });
      } else {
        recognition.stop();
        isRecording = false;
        recordBtn.innerHTML = "Record";
      }
    }

    function edit() {
      let txtarea = document.getElementById("voice-input");
      txtarea.disabled = !txtarea.disabled;
    }

    function send() {
      const data = document.getElementById("voice-input").value;
      const errorMsg = document.getElementById("error-msg");
      const gptResult = document.getElementById("gpt-result");
      gptResult.innerText = "Loading...";
      fetch("/api/", {
        method: "POST",
        headers: {
          "Content-Type": "text/plain",
        },
        body: data,
      })
        .then((res) => {
          return res.json();
        })
        .then((data) => {
          console.log(data);
          if (data.error) {
            gptResult.innerText = "Result will be displayed here";
            errorMsg.querySelector("p").innerText = data.error;
            errorMsg.showModal();
            return;
          }
          gptResult.innerText = data.message;
        })
        .catch((err) => {
          console.error(err.json().error);
          gptResult.innerText = "Result will be displayed here";
          errorMsg.innerHTML += "\nError: " + err;
          errorMsg.showModal();
        });
    }

    function speak() {
      console.log("Speak");
    }
  </script>
</head>

<body>
  <div>
    <h1>Voice to Voice Bot</h1>
    <label for="voice-input"></label>
    <textarea name="voice-input" id="voice-input" disabled> </textarea><br />
    <button onclick="edit()" id="edit">Edit</button>
    <button onclick="record()" id="record">Record</button>
    <button type="button" onclick="send()" id="send">Send</button>
    <p id="gpt-result">Result will be displayed here</p>
    <button onclick="speak()">Speak</button>
    <dialog id="error-msg">
      <p></p>
      <button onclick="document.getElementById('error-msg').close()">
        X
      </button>
    </dialog>
  </div>
</body>

</html>
